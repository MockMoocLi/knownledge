# IP协议



## 概述

IP协议是TCP/IP族中最核心的协议。 所有的TCP、UDP、ICMP都以IP数据报格式传输。

它的特点有：

- 不可靠：它不保证IP数据报能成功到达目的地。如果发生某种错误时，比如说某个路由器暂时用完了缓冲区，IP协议有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP数据报给发送端。  任何要求的可靠性必须由上层来提供（如TCP）。
- 无连接：IP协议不维护任何数据报的状态信息。每个数据报的处理是独立的。这也说明，IP数据报可以不按发送顺序接收。如果一个发送端向同一个接收端连续发送2个IP数据报，分别是数据报A、B，每个数据报都是独立的进行路由选择，可能选择不同的路线，因此B可能在A之前先达到。





## IP首部

![image-20200516130452305](https://tva1.sinaimg.cn/large/007S8ZIlgy1geu7j92vvwj312k0pen1x.jpg)

分析图3-1中的首部，最高位在左边，记为0bit；最低位在右边，记为31bit。

- 版本号：目前协议版本号是4，因此IP有时候也称为IPv4。
- 首部长度：标识了IP数据报首部的长度。普通IP数据报（没有任何选项）的字段值是5。
- 服务类型：包括3 bit的优先权字段（取值可以从000-111所有值），4 bit的TOS子字段分别代表：最小时延、最大吞吐量、最高可靠性和最小费用。4 bit中只能置其中1 bit。如果所有4 bit均为0，那么就意味着是一般服务，1 bit未用位但必须置0。简单来说代表优先级，例如语音数据优先或者视频流优先等等。
- 总长度：指的是整个IP数据报的长度。以字节为单位。
  - 利用总长度字段和首部长度字段，就可以知道IP数据报内容的起始位置和长度。由于该字段占16bit，所以IP数据报最长可达65535字节。
  - 总长度字段是IP首部中必要的内容，因为一些数据链路需要填充一些数据已达到最小长度，比如说以太网的最小长度为46字节，但是IP数据报可能更短，这时候就要进行填充数据。如果没有总长度字段，那么IP层就不知道46字节中有多少是IP数据报的内容。
- 标识字段：唯一的标识主机发送的每一份数据报。通常没发送一份报文它的值就会加1。
- TTL生成时间字段：设置了数据报最多可以经过的路由器数。TTL的初始值由源主机设置，通常为32或64。一旦经过一个处理它的路由器，该值就会减1。当该值为0的时候，数据报就会被丢弃，并发送ICMP报文通知源主机。
- 协议字段：TCP可以传递数据给IP，UDP也可以。那么IP就用协议字段来表示该数据报是哪个协议传递给IP的。那么在IP对数据报进行分用的时候，就可以把数据报传递给正确的上层协议。
- 首部校验和字段：是根据IP首部计算的校验和码，它不对首部后面的数据进行计算。接收方利用该字段来判断传输过程中首部是否发生了变化。如果校验和错误，那么IP就丢弃数据报，但是不生成ICMP报文，由上层发现丢失的数据报并进行重传。
- 源IP和目的IP地址字段
- 选项字段：是数据报中可变长的可选信息。比如说时间戳等。







## IP路由选择

描述了数据报如何路由到目的主机。  如果目的主机和源主机在同一个网络，那么IP数据报就直接送到目的主机上。否则，源主机把数据报发完默认路由器上，由路由器转发该数据报。

IP可以从TCP、UDP、ICMP、IGMP接收数据报（即在本地生成数据报）并进行发送，或者从一个接口接收数据报并进行发送。  IP层在内存中有一个路由表。当收到数据报并进行发送时，它都要对该表搜索一次。当数据报来自某个网络接口时，IP协议首先检查目的地址是否为本机IP地址或者广播地址。如果是，则数据报被送到IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么如果IP层被设置为路由器的功能，那么就对数据报进行转发，否则数据报被丢弃。

路由表中每一项都包含下面这些信息：

- 目的IP地址：它既可以是一个完整的主机地址，也可以是一个网络地址，由该表目中的标志字段来指定。主机地址有一个非0的主机号，以指定某一特定的主机。而网络地址中的主机号为0，以指定网络中的所有主机。
- 下一站路由的IP地址：下一站路由器指一个直接相连网络的路由器，通过它可以转发数据报。下一站路由器不是最终目的地，但是它可以把数据转发给最终目的机器
- 标志：有两个标志，其中一个表明IP地址是主机地址，还是网络地址。另外一个表明下一站路由器是否为真正的下一站路由器，还是一个直接相连的接口。
- 为数据报的传输指定一个网络接口。



IP路由选择是逐跳进行的。从上述路由表信息可以看出，IP并不知道到达任何目的地的完整路径。所有IP路由选择只为数据提供下一站路由器的IP地址。它假定下一站路由器比源主机更接近目的地，而下一站路由器和目的地直接相连。

IP路由选择主要完成一下功能：

1. 搜索路由表，寻找与目的IP地址完全匹配的表目（网络号和主机号都要匹配）。如果找到，则把数据转发给下一站路由器或者直接连接的网络接口。
2. 搜索路由表，寻找能与目的网络号匹配的表目。如果找到，则把报文转发给该表目指定的下一站路由器或者直接相连的网络接口（取决于标志字段的值）。目的网络上所有主机都可以通过这个表目来进行处理。这种搜索网络的匹配方法必须考虑所有可能的子网掩码。
3. 搜索路由表，寻找标为“默认”的表目，把数据转发给该表目指定的下一站路由器。

如果上面的步骤都没有匹配，则该数据报不能被传送。如果不能传送的数据报来自本机，则给生成数据的应用程序返回一个“主机不可达”或者“网络不可达”的错误。

完整主机地址匹配在网络号匹配之前执行，只有当他们都失败了后才选择默认路由器。