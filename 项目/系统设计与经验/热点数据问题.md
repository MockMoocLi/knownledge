# 热点数据



## 背景

某个业务线 商品开放开用户申请免费试用，当某个商品特别吸引人时，比如iPhone6 。肯定有一大波人为了少卖一个肾 疯狂去抢申请资格。有甚者利用机器人申请注册，于是简单的申请操作变成了秒杀行为。

大量请求同时更新数据库中的同一个商品的申请次数，update 操作给表加上行锁，导致后面的请求全部排队等待前面一个update完成，释放行锁后才能处理下一个请求。大量后来请求等待，占用了数据库的连接。一旦数据库连接数被占满，就会导致后来的全部请求因拿不到连接而超时，业务请求出现无法及时处理的情况，数据库系统的RT（响应时间）会异常飙高，业务层由于等待出现超时，app 层的连接耗尽，一系列的雪崩效应！





## 解决方案

从上面的背景分析，解决热点数据并发更新需要注意核心问题：

减少直接对db层数据热点的并发更新，本文从业务和数据库的设计层面来规划。



### 前端层面

前端是整个流量的入口， 正常业务访问时系统表现平稳，但是当有人恶意请求时，需要加上**限流**，比如常见的

- a 需要用户回答问题，填写**图形验证码**，移动图像等等，防止或者减少有机器人来恶意请求。 
- b 页面上采用防止机器人的判断 两秒以内的成功请求一律拒绝。
- c 通过**设置nginx ，对同一个ip的请求次数做限制，防止机器人来申请。** 




优点 有效减少或者防止有人利用机器人恶意请求

 缺点 存在一定的误杀率，错杀了正常的请求。 





### 应用层面

应用程序接收前端前端请求，进行一系列的数据库操作，在我们规避了恶意请求之后如果还是有大量的数据库写访问请求，我们需要：



a、对业务做降级
 降级是指放弃部分非核心功能，保证整体的可用性。是一种有损的系统容错方式。
 比如说秒杀系统里面除了展示商品数据，还会展示用户的评论数据，评论数据是先从缓存加载，没有再从数据库加载。如果数据库压力大了，建议对“评价”这个业务做降级处理，只从缓存里面加载评论数据，从而降低数据库压力，把数据库资源留给核心业务。



b、通过异步更新来避免直接写数据库 。
   使用分布式缓存(比如Redis)来存储某项商品的申请次数或者某人的申请次数，以商品id/user_id 或者将where 条件作为key，申请试用人数为value/符合某项具体条件的 count结果为value，有用户申请成功则更新申请试用人数。不需要查询和实时写数据库，每隔一定时间/次数将结果写入数据库。

优点：该方法完全依赖于缓存，读写速度快，不需要实时更新数据库，减轻数据库并发写的压力;
缺点：缓存不是100%稳定，很容易丢，即使采用持久化的缓存，在高并发下有时也可能会出现异常，穿透缓存到db ，导致前端业务展现问题。



c、限流

可以使用限流算法对系统进行限流处理，比如说令牌桶算法。这样子可以避免流量突然增大导致系统整体不可用，起到保护系统的作用。







### 数据库层面

**对于数据库的热点数据行，可能有很多请求同时到达数据库了，然后对这个数据进行更新，怎么处理这种情况?**

- 将热点数据拆分，分在不同的库、不同的表中
  - 分散热点数据，减轻数据库并发更新热点带来的RT升高
  - 如果某个数据库真的抗不住，那么其他库也可能继续运行，系统整体保持可用性。
  - 举个例子，比如说库存，单条记录是100的数据，可以拆分层5条记录，每个记录是20条，理论上性能能提高5倍
- 使用限流补丁
  - 针对某些特定的sql，从MySQL层面加以限制。当系统运行线程数超过一定值或者sql执行时间超过一定阈值，则拒绝该sql的执行。



优点：减少加锁和死琐检查带来的性能开销

缺点：在测试过程中发现，会有大量的连接等待kernel mutex锁，但是持续的压力会导致MySQL的thread running飙高，最终导致MySQL不可用。









## Redis处理热点数据问题

- 设置缓存永不过期。这种方案需要注意几点：
  - 区分热点数据。因为内存是有限，而如果数据超过内存，会导致磁盘交换，从而影响性能
  - 数据预热。在高峰期之前，提现把数据加载到缓存中
  - 更新商品信息。如果商品信息更新了，可以通过MQ异步更新缓存中的商品信息
- 使用Redis集群
  - 避免单点问题
  - 提高Redis整体的性能
- 使用多级缓存
  - 可以在主从集群之前再加一级缓存，存放更加热的数据。当客户端请求过来的时候，优先请求一级缓存，没有找到，再查找主从集群。



### 查找热点数据

- 人工统计
- 利用redis的 `/redis-cli --hotkeys` 可以获取访问频率高的key。这些key对应的数据就是热点数据。









## 参考

[热点数据更新问题](http://blog.itpub.net/22664653/viewspace-1269948)

[海量数据的计数器](https://time.geekbang.org/column/article/179373)

[Redis热点数据问题](https://www.jianshu.com/p/b08a8f7c79bf)

