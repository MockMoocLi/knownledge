# Nginx



## 概述

Nginx是一个高性能的HTTP服务器，特点是占用内存小，并发能力强。



## 作用

Nginx的作用是：承接前端的 HTTP 请求，然后将这些请求按照策略分发给后端的多个业务服务器上。这样，我们可以随时通过扩容业务服务器的方式来抵挡突发的流量高峰





## 反向代理

了解反向代理之前，我们首先了解一下正向代理。正向代理就是我们常说的代理服务器，帮用户去获取网络信息，然后返回信息给用户。比如说我们不能访问一些外国网站，但是可以通过VPN来访问。这个VPN就是代理服务器。

反向代理是为服务器集群进行代理。客户端通过“反向代理服务器”，向“反向代理服务器”后面的服务器集群获取数据。

举个例子：

客户端（用户A）向反向代理发送普通请求，接着反向代理将判断向哪一台原始服务器转交请求，并将获得的内容返回给客户端。

而客户端始终认为它访问的是原始服务器而不是服务器Z。由于防火墙作用，只允许服务器Z进出，防火墙和反向代理共同作用保护了服务器B。

![image-20200726134029241](https://tva1.sinaimg.cn/large/007S8ZIlgy1gh4bk5e7ekj31040b8n6z.jpg)



### 用途

反向代理提供负载均很服务，并且请求只能通过反向代理再转发给服务器集群，提高了安全性。





## 负载均衡

**就是将反向代理服务器接收到的请求按照规则进行分发的过程**

- weight轮询(默认)：接收到的请求按照顺序逐一分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，Nginx会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。 这种方式下，可以给不同的后端服务器设置一个权重值(weight)，用于调整不同的服务器上请求的分配率；权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。
- ip_hash：每个请求按照发起客户端的ip的hash结果进行匹配，这样的算法下一个固定ip地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下session共享的问题。（最好的方式还是服务无状态）
- url_hash：按照访问的url的hash结果分配请求，每个请求的url会指向后端固定的某个服务器，可以在Nginx作为静态服务器的情况下提高缓存效率。同样要注意Nginx默认不支持这种调度算法，要使用的话需要安装Nginx的hash软件包。





## Nginx优势

- Nginx采用内核poll模型，可以支持更多的并发连接，占用内存小，占用CPU小。
- 使用Nginx可以实现后台服务器的负责均衡，从而提高整个系统的性能
- 支持热部署。可以在不重启的情况下对配置进行升级。





## LVS

LVS是负载均衡服务器的一种。

LVS 在 OSI 网络模型中的第四层，传输层工作，所以 LVS 又可以称为四层负载；而 Nginx 运行在 OSI 网络模型中的第七层，应用层，所以又可以称它为七层负载。

在项目的架构中，我们一般会同时部署 LVS 和 Nginx 来做 HTTP 应用服务的负载均衡。也就是说，在入口处部署 LVS 将流量分发到多个 Nginx 服务器上，再由 Nginx 服务器分发到应用服务器上，为什么这么做呢？

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gh4c0qsr3rj30ti0mudhi.jpg" alt="image-20200726135626073" style="zoom:50%;" />

主要和 LVS 和 Nginx 的特点有关，LVS 是在网络栈的传输层做请求的转发，**请求包转发之后，由客户端和后端服务直接建立连接，后续的响应包不会再经过 LVS 服务器**，所以**相比 Nginx 性能会更高，也能够承担更高的并发**。

可**LVS 缺陷是工作在四层，而请求的 URL 是七层的概念，不能针对 URL 做更细致地请求分发**，而且 LVS 也没有提供探测后端服务是否存活的机制；而 Nginx 虽然比 LVS 的性能差很多，但也可以承担每秒几万次的请求，并且它在配置上更加灵活，还可以感知后端服务是否出现问题。

因此，LVS 适合在入口处承担大流量的请求分发，而 Nginx 要部署在业务服务器之前做更细维度的请求分发。我给你的建议是，如果你的 QPS 在十万以内，那么可以考虑不引入 LVS 而直接使用 Nginx 作为唯一的负载均衡服务器，这样少维护一个组件，也会减少系统的维护成本。





##参考

[Nginx的作用](https://blog.csdn.net/weixin_44282540/article/details/88854310)